#!/bin/bash

# ðŸ‘½ðŸ’¾â˜„ï¸ LAZERBEAM BACKUP 3000
# "ALL FILES MUST BLEED"
# iPhone photo backup script via GVFS & rsync with checksum verification
# Fully resumable, interruption-safe version ("Gold")

set -euo pipefail

# ðŸ’£ Trap interruptions (Ctrl+C, SIGTERM)
trap 'echo -e "\nâŒ Backup interrupted by user. Exiting."; echo "â›” INTERRUPTED at $(date)" >> "$LOG_FILE"; exit 130' SIGINT SIGTERM

# ðŸŽ¯ SETUP
USERNAME=$(whoami)
DEFAULT_BACKUP_DIR="/var/home/$USERNAME/Pictures/iphone-lazerbackup"
BACKUP_DIR="${1:-$DEFAULT_BACKUP_DIR}"
LOG_FILE="$BACKUP_DIR/lazerbeam.log"

mkdir -p "$BACKUP_DIR"

# ðŸ‘¾ ASCII BANNER PLS
cat << "EOF"

ðŸ‘½ðŸ’¾â˜„ï¸ LAZERBEAM BACKUP 3000 â˜„ï¸ðŸ’¾ðŸ‘½
     ðŸ’‰ ALL FILES MUST BLEED ðŸ’‰

â–‘â–’â–“â–ˆâ–“â–’â–‘       â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘  
â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ 
â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘    â–‘â–’â–“â–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ 
â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘  â–‘â–’â–“â–ˆâ–ˆâ–“â–’â–‘  â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘ â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘ â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ 
â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–“â–’â–‘    â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ 
â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘      â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ 
â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘â–‘â–’â–“â–ˆâ–“â–’â–‘ 
                                                                                                                              
                                                                                                                              
EOF

# ðŸ“† LOG START
echo -e "\nðŸ›¸ INITIATING LAZERBEAM BACKUP SEQUENCE..."
echo "ðŸ“‚ Target directory: $BACKUP_DIR"
echo "ðŸ“† $(date)" >> "$LOG_FILE"

# ðŸ“¡ FIND IPHONE MOUNT
IPHONE_MOUNT=$(find /run/user/1000/gvfs/ -mindepth 1 -maxdepth 2 -type d -name 'gphoto2:*' | head -n 1)

if [ -z "$IPHONE_MOUNT" ]; then
    echo "âŒ CRITICAL ERROR: iPhone not mounted. Plug it in, unlock it, trust the computer, and try again."
    echo "âŒ Backup aborted at $(date)" >> "$LOG_FILE"
    exit 1
fi

echo "âœ… iPhone detected at: $IPHONE_MOUNT"

# ðŸ”¬ SCAN FOLDERS
FOLDER_LIST=$(find "$IPHONE_MOUNT" -mindepth 1 -maxdepth 3 -type d)
FOLDER_COUNT=$(echo "$FOLDER_LIST" | wc -l)

echo "ðŸ“ Found $FOLDER_COUNT folder(s) to examine. Deploying lazers..."

# ðŸ”„ COPY FILES WITH CHECKSUM + FEEDBACK
INDEX=1
while IFS= read -r FOLDER; do
    RELATIVE_PATH="${FOLDER#$IPHONE_MOUNT/}"
    TARGET_FOLDER="$BACKUP_DIR/$RELATIVE_PATH"
    mkdir -p "$TARGET_FOLDER"

    FILE_COUNT=$(find "$FOLDER" -type f | wc -l)
    echo -e "\n[$INDEX/$FOLDER_COUNT] ðŸ”« Checking $RELATIVE_PATH"

    if [ "$FILE_COUNT" -eq 0 ]; then
        echo "âš ï¸  No files in $RELATIVE_PATH â€” skipping!"
        ((INDEX++))
        continue
    fi

    # Preload contents to reduce gvfs latency
    gio list "$FOLDER" &>/dev/null || ls "$FOLDER" &>/dev/null

    echo "ðŸ“¥ Copying $FILE_COUNT file(s) from $RELATIVE_PATH to $TARGET_FOLDER"

    stdbuf -oL rsync -ah --checksum --info=progress2 "$FOLDER/" "$TARGET_FOLDER/" 2>&1 | tee -a "$LOG_FILE"

    ((INDEX++))
done <<< "$FOLDER_LIST"

# ðŸ§ª POST-RUN: CHECK FOR ACTUAL DUPLICATES
DUPLICATE_LOG="$BACKUP_DIR/lazerbeam-duplicates.txt"
echo -e "\nðŸ§  ANALYZING for true duplicates..."
find "$BACKUP_DIR" -type f -exec sha256sum {} + | sort | uniq -d --check-chars=64 > "$DUPLICATE_LOG" || true

if [[ -s "$DUPLICATE_LOG" ]]; then
    echo "âš ï¸ DUPLICATES FOUND. See: $DUPLICATE_LOG"
else
    echo "âœ… No duplicates detected. Hash clean."
    rm "$DUPLICATE_LOG"
fi

# ðŸ DONE
echo -e "\nðŸš€ BACKUP COMPLETE. All your JPEG are belong to us."
echo "âœ… $(date) â€” SUCCESS" >> "$LOG_FILE"
